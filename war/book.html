<!doctype html>
<html lang="en">
	<head>
		<script type="text/javascript">
			// https redirect workaround for static files
			if (window.location.protocol != "https:") {
				window.location.replace(window.location.href.replace("http://", "https://").replace("//bookstuf.com", "//www.bookstuf.com"));
			}
		</script>
		
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		<!-- jQuery -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		
		<!-- Hogan -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/hogan.js/3.0.2/hogan.min.js"></script>
		
		<!-- JavaScript Cookie -->
		<script src="cookie.js"></script>
		
		<!-- gitkit -->
		<script type="text/javascript" src="https://www.gstatic.com/authtoolkit/js/gitkit.js"></script>
		<link type=text/css rel=stylesheet href="https://www.gstatic.com/authtoolkit/css/gitkit.css" />

		<!-- dropzone.js -->
		<script src="dropzone.js"></script>
		<link type=text/css rel=stylesheet href="dropzone.css" />

		<!-- bookstuf -->
		<script type="text/javascript" src="bookstuf.js"></script>
		<link type=text/css rel=stylesheet href="bookstuf.css" />
			
		<!-- Stripe -->	
		<script type="text/javascript" src="https://js.stripe.com/v2/"></script>	
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.payment/1.3.2/jquery.payment.min.js"></script>	
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/3.1.62/jquery.inputmask.bundle.min.js"></script>
			
		<!-- material design light -->
		<link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.0.0/material.blue-red.min.css">
		<script src="https://storage.googleapis.com/code.getmdl.io/1.0.0/material.min.js"></script>
		<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700" rel="stylesheet" type="text/css">

		<script id="calendar-template" type="x-tmpl-mustache">
			{{#days}}
			<div class="day-container" id="day-container-{{index}}">
				<div class="day-header">
					<span class="day-header-day-of-week">{{dayOfWeek}}</span>
					<span class="day-header-month">{{month}}</span>
					<span class="day-header-day">{{dayOfMonth}}</span>
				</div>
				<div class="day-agenda" data-index="{{index}}">
					{{#bookedTimes}}
						{{#isPrivate}}
						<div class="booking" style="top: {{top}}px; height: {{height}}px;"></div>
						{{/isPrivate}}

						{{^isPrivate}}
						<div class="consumer-booking booking" style="top: {{top}}px; height: {{height}}px;">
							<span class="consumer-booking-start-time">{{startTime}}</span>
							<span class="consumer-booking-title">{{title}}</span>
						</div>
						{{/isPrivate}}
					{{/bookedTimes}}
				</div>
			</div>
			{{/days}}
		</script>

		<script id="card-template" type="x-tmpl-mustache">
			<div class="group">    
				<select id="cardId" class="valid">
					<option {{#cardsFull}}disabled{{/cardsFull}} {{#noCards}}selected{{/noCards}} value="addNewCard">
						Add new card
					</option>
					{{#cards}}
					<option {{#deleted}}disabled{{/deleted}} {{#isDefault}}selected{{/isDefault}} value="{{id}}">
						{{brand}} ending in {{last4}}, exp. {{expMonth}}/{{expYear}}
					</option>
					{{/cards}}
				</select>
				<span class="bar"></span>
				<label class="select-label">Credit Card</label>
			</div>
		</script>

		<script id="services-template" type="x-tmpl-mustache">
			<div class="group">    
				<select id="serviceId" class="valid">
					{{#services}}
					<option value="{{id}}" data-title="{{name}}" data-duration="{{duration}}">
						{{name}}, ${{cost}}
					</option>
					{{/services}}
				</select>
				<span class="bar"></span>
				<label class="select-label">Service</label>
			</div>
		</script>

		<script type="text/javascript">
		
		
		
			var calendarTemplate;

			var height = 50;
			
			
			function loadCalendar(callback) {
				$.get('/booking/availability', {'professionalUserId' : getUrlParameter("id")})
				.done(function(data) {
					var calendarData = JSON.parse(data);
					$('#calendar').html(calendarTemplate.render({'days': calendarData}));
					
					var inFixedState = false;
					
					var currentHover;
					var currentAgenda;
					var currentAgendaData;
					
					var yStart = 0;
					var yEnd = yStart + 50; // TODO: change to actual service length
									

					
					var updateTime = function() {
						var hour = Math.floor(yStart / 50);
						var minute = ((yStart % 50) * 60) / 50;
						var ampm;
						
						if (hour == 0) {
							hour = 12;
							ampm = 'AM';
							
						} else if (hour <= 11) {
							ampm = 'AM';
							
						} else if (hour == 12) {
							ampm = 'PM';
							
						} else {
							hour = hour - 12;
							ampm = 'PM';
						}
						
						$('#booking-time').text(hour + ':' + (minute < 10 ? '0' : '') + minute + ' ' + ampm);
					}
					
					// find first available spot
					
					var tryOffset = function(pixel) {
						var yStartNew = (pixel + yStart);
						var yEndNew = (pixel + yEnd);
						
						if (
							yStartNew < 0 ||
							yEndNew > (24 * 50)
						) {
							// booking is off the agenda, invalid
							return false;
						}
						
						var hasSolution = true;
						
						for (i = 0; i < currentAgendaData.length; i++) {
							var booking =
								currentAgendaData[i];
							
							var bookingStart =
								booking['top'];
							
							var bookingEnd =
								booking['top'] + booking['height'];
							
							if (
								yStartNew >= bookingEnd ||
								bookingStart >= yEndNew
							) {
								// this one is good
								
							} else {
								hasSolution = false;
							}
						}

						if (hasSolution) {
							// here we have a good solution
							yStart = yStartNew;
							yEnd = yEndNew;
							currentHover.css('top', yStart + 'px');
							return true;
							
						} else {
							return false;
						}
					}
					
					var findClosestSolution = function() {
						// iterate over all 25 pixel increments (30 minutes)
						for (pixel = 0; pixel < (50 * 24); pixel += 25) {
							if (tryOffset(pixel)) {
								return true;
							}
							
							if (tryOffset(-pixel)) {
								return true;
							}
						}
						
						return false;
					}
					
					$(".day-agenda").mouseenter(function(event) {
						if (!inFixedState) {
							currentHover =
								$('<div class="booking-selection-hover" id="currentHover"></div>');

							currentHover.css('height', height + 'px');
							
							currentHover.click(function(event) {
								inFixedState = !inFixedState;
								
								if (inFixedState) {
									currentHover.addClass("booking-selection").removeClass("booking-selection-hover");
									
								} else {
									currentHover.addClass("booking-selection-hover").removeClass("booking-selection");
								}
							});
							
							currentAgenda =
								$(this)[0];
							
							var index = 
								$(this).attr('data-index');
							
							currentAgendaData =
								calendarData[index]['bookedTimes'];
							
							$(this).append(currentHover);
					
							if (findClosestSolution()) {
								// valid solution found, set date
								updateTime();
								$('#booking-date').text(calendarData[index]['day']);
								currentHover.text($('#booking-time').text() + ' ' + $('#serviceId').find(":selected").attr('data-title'));
								
							} else {
								// no valid location found
								currentHover.remove();
							}
						
						}
					});
					
					$(".day-agenda").mouseleave(function(event) {
						if (!inFixedState) {
							currentHover.remove();
						}
					});
					
					$(".day-agenda").mousemove(function(event) {
						if (!inFixedState) {
							yStart = (Math.round((event.clientY - currentAgenda.getBoundingClientRect()['top']) / 25.0) * 25) - (height / 2.0);
							yEnd = yStart + height;
						
							var valid = findClosestSolution();
							
							if (valid) {
								updateTime();
								currentHover.text($('#booking-time').text() + ' ' + $('#serviceId').find(":selected").attr('data-title'));
							}
						}
					});
					
					callback();
				});
			}
		
			$(function() {

				var id = 
					getUrlParameter("id");
				
				calendarTemplate = 
					Hogan.compile($('#calendar-template').html());
				
				loadCalendar(function() {
					window.scrollTo(0, 375);
				});

			
				
				$('#cc-number').payment('formatCardNumber');
				$('#cc-exp').payment('formatCardExpiry');
				$('#cc-cvc').payment('formatCardCVC');
				
				var cardTemplate = 
					Hogan.compile($('#card-template').html());
				
				$.get('/cards/all')
				.done(function(data) {
					var cardData = 
						JSON.parse(data);
					
					$('#cards').html(cardTemplate.render({
						'cards': cardData,
						'cardsFull': (cardData.length >= 10),
						'noCards' : (cardData.length == 0)
					}));
					
					var show = {
						'visibility': 'visible', 
						'height': ''};
					
					var hide = {
						'visibility': 'collapse', 
						'height': '0px'};
					
					if (cardData.length == 0) {
						$('#add-new-card-form').css(show);
						
					} else {
						$('#add-new-card-form').css(hide);
					}
					
					$('#cardId').change(function() {
						var addNewCard =
							($('#cardId').val() === 'addNewCard');
						
						if (addNewCard) {
							$('#add-new-card-form').css(show);
							
						} else {
							$('#add-new-card-form').css(hide);
						}
					});
				});

				
				
				var servicesTemplate = 
					Hogan.compile($('#services-template').html());
				
				$.get('/user/getUserInformationWithId', {'professionalUserId' : id})
				.done(function(data) {
					var servicesData = JSON.parse(data);
					$('#services').html(servicesTemplate.render(servicesData));

					$('#serviceId').change(function() {
						height = ($(this).find(":selected").attr('data-duration') * 50) / 60;
						$('#currentHover').css('height', height + 'px');
						$('#currentHover').text($('#booking-time').text() + ' ' + $(this).find(":selected").attr('data-title'));
					});
					
					$('#serviceId').val(getUrlParameter("serviceId"));
					
					height = ($('#serviceId').find(":selected").attr('data-duration') * 50) / 60;
					$('#currentHover').css('height', height + 'px');
					$('#currentHover').text($('#booking-time').text() + ' ' + $(this).find(":selected").attr('data-title'));
				});
				
				$('#book-now-button').click(function() {
					$('.payment-errors').text('');
					
					$('#book-now-button').prop('disabled', true);
					
					Stripe.setPublishableKey('pk_test_N0zNZdZs8d59IaOqOGnL8nHa');
					
					var validatedCcExp =
						$('#cc-exp').payment('cardExpiryVal');
					
					var addNewCard =
						($('#cardId').val() === 'addNewCard');
					
					var book = function(token, setNewCardAsDefault) {
						$.post('/booking/book', JSON.stringify({
							'professionalUserId' : id,
							'serviceId' : $('#serviceId').val(), 
							'date' : $('#booking-date').text(), 
							'startTime' : $('#booking-time').text(), 
							'paymentMethod' : 'STRIPE_CARD', // TODO: add input for card vs. cash
							'addNewCard' : addNewCard,
							'setNewCardAsDefault' : setNewCardAsDefault, // TODO: need input to set new card as default
							'stripeToken' : token,
							'cardId' : $('#cardId').val()
							
						})).done(function(data) {

							// TODO: goto confirmation page ?
							loadCalendar(function() {
								$('#book-now-button').prop('disabled', false);
							});

							
						}).fail(function(data) {
							// TODO: handle errors
							$('.payment-errors').text('Unable to create booking');
							$('#book-now-button').prop('disabled', false);
							loadCalendar(function() {});
						});
					};
					
					if (addNewCard) {
						Stripe.card.createToken({
							number: $('#cc-number').val(),
							cvc: $('#cc-cvc').val(),
							exp_month: validatedCcExp['month'],
							exp_year: validatedCcExp['year']
						}, function(status, response) {
							if (response.error) {
								// Show the errors on the form
								$('.payment-errors').text(response.error.message);
								
								$('#book-now-button').prop('disabled', false);
							} else {
								// response contains id and card, which contains additional card details
								var token = response.id;
								console.log('token: ' + token);
								
								book(token, true);
							}
						});
					} else {
						book('null', false);
					}
				});
			});
		</script>
		
		<style>
			.half-field {
				width: 146px;
			}
			
			.labeless-field {
				padding: 10px 0;
			}
			
			.day-container {
				float: left;
				width: 200px;
			}
			
			.day-header {
				height: 40px;
			}
			
			.day-agenda {
				position: relative;
				height: 1200px;
				z-index: 0;
			}
			
			.booking-selection-hover {
				position: absolute;
				z-index: 30;
				background: red;
				width: 100%;
				height: 50px;
			}
			
			.booking-selection {
				position: absolute;
				z-index: 30;
				background: #4F4;
				width: 100%;
				height: 50px;
			}
			
			.booking {
				position: absolute;
				z-index: 10;
				background: gray;
				width: 100%;
			}
			
			.consumer-booking {
				position: absolute;
				z-index: 20;
				background: orange;
			}
			
			.appointment-card {
				position: fixed;
				
				bottom: 30px;
				right: 30px;
				    
				width: 320px;
				/* height: 200px; */
				
				padding: 10px;
			}
			
			.payment-errors {
				color: red;
			}
		</style>
		
		
		<title>bookstuf.com - book an appointment</title>
		
		<script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		
		  ga('create', 'UA-66119190-1', 'auto');
		  ga('send', 'pageview');
		
		</script>
	</head>

<body>
	<div class="calendar" id="calendar"></div>

	<div class="mdl-card mdl-shadow--6dp appointment-card">
		<span class="payment-errors"></span><br />
		
		<span>Date: <span id="booking-date"></span></span>
		<span>Time: <span id="booking-time"></span></span>

		<div class="services" id="services"></div>
		<div class="cards" id="cards"></div>
		
		<div id="add-new-card-form" style="visibility: collapse; height: 0px;">
			<div class="labeless-field mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
				<input class="mdl-textfield__input" type="text" size="20" id="cc-number" placeholder="•••• •••• •••• ••••" type="tel" class="cc-number" name="cardNumber" autocomplete="on" />
			</div><br />
			
			<div class="labeless-field mdl-textfield mdl-js-textfield mdl-textfield--floating-label half-field">
				<input class="mdl-textfield__input" type="text" size="7" id="cc-exp" placeholder="MM/YY" type="tel" class="cc-exp" name="cardExpiration" autocomplete="on" />
			</div>
			
			<div class="labeless-field mdl-textfield mdl-js-textfield mdl-textfield--floating-label half-field">
				<input class="mdl-textfield__input" type="text" size="4" id="cc-cvc" placeholder="CVC" type="tel" />
			</div><br />
	
		</div>		
		
		<button style="margin-top: 15px;" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect" id="book-now-button">Book now</button>	
	</div>



</body>
</html>
